<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cron Job Scheduler</title>
    <script src="paho.javascript-1.0.3/paho-mqtt-min.js"></script>
    <script src="connection.js"></script>
</head>
<body>
    <h1>Cron Job Scheduler</h1>

    <!-- Form to Schedule a New Job -->
    <h2>Schedule a New Job</h2>
    <form id="scheduleJobForm">
        <label for="scheduleJobId">Job ID:</label>
        <input type="text" id="scheduleJobId" name="id" required>
        <label for="scheduleCronTime">Cron Time:</label>
        <input type="text" id="scheduleCronTime" name="cronTime" required>
        <label for="scheduleTask">Task:</label>
        <input type="text" id="scheduleTask" name="task" required>
        <button type="submit">Schedule Job</button>
    </form>

    <!-- Form to Update an Existing Job -->
    <h2>Update an Existing Job</h2>
    <form id="updateJobForm">
        <label for="updateJobId">Job ID:</label>
        <input type="text" id="updateJobId" name="id" required>
        <label for="updateCronTime">New Cron Time:</label>
        <input type="text" id="updateCronTime" name="cronTime" required>
        <label for="updateTask">New Task:</label>
        <input type="text" id="updateTask" name="task" required>
        <button type="submit">Update Job</button>
    </form>

    <!-- Form to Cancel a Job -->
    <h2>Cancel a Job</h2>
    <form id="cancelJobForm">
        <label for="cancelJobId">Job ID:</label>
        <input type="text" id="cancelJobId" name="id" required>
        <button type="submit">Cancel Job</button>
    </form>

    <!-- Display Jobs -->
    <h2>Scheduled Jobs</h2>
    <button id="getJobsBtn">Get Scheduled Jobs</button>
    <pre id="result"></pre>




</div>

<div class="container">
    <h2>Schedule - Repeat</h2>
    <form id="scheduleRepeatForm">
      <label for="scheduleRepeatName">Schedule Name:</label>
      <input type="text" id="scheduleRepeatName" name="scheduleRepeatName" required>
      <br><br>
      <label for="scheduleRepeatDays">Select Days:</label><br>
      <input type="checkbox" id="monday" name="scheduleRepeatDays" value="1">
      <label for="monday">Monday</label><br>
      <input type="checkbox" id="tuesday" name="scheduleRepeatDays" value="2">
      <label for="tuesday">Tuesday</label><br>
      <input type="checkbox" id="wednesday" name="scheduleRepeatDays" value="3">
      <label for="wednesday">Wednesday</label><br>
      <input type="checkbox" id="thursday" name="scheduleRepeatDays" value="4">
      <label for="thursday">Thursday</label><br>
      <input type="checkbox" id="friday" name="scheduleRepeatDays" value="5">
      <label for="friday">Friday</label><br>
      <input type="checkbox" id="saturday" name="scheduleRepeatDays" value="6">
      <label for="saturday">Saturday</label><br>
      <input type="checkbox" id="sunday" name="scheduleRepeatDays" value="0">
      <label for="sunday">Sunday</label><br><br>
      <label for="scheduleRepeatTime">Select Time:</label>
      <input type="time" id="scheduleRepeatTime" name="scheduleRepeatTime" required>
      <br><br>
      <button type="submit">Create Schedule</button>
    </form>
    <div id="scheduleRepeatResult"></div>

    <script>


document.getElementById('scheduleRepeatForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const scheduleName = document.getElementById('scheduleRepeatName').value;
    const days = Array.from(document.querySelectorAll('input[name="scheduleRepeatDays"]:checked'))
                      .map(day => day.value)
                      .join(', ');
    const scheduleTime = document.getElementById('scheduleRepeatTime').value;
    displayResult('scheduleRepeatResult', `Repeating Schedule "${scheduleName}" set for ${days} at ${scheduleTime}`);
console.log(days);

       
    fetch('http://localhost:3000/schedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ scheduleName, days, scheduleTime })
            })
            .then(response => response.text())
            .then(data => {
                alert(data);
                getJobs();
            })
            .catch(error => console.error('Error scheduling job:', error));
  });




  function displayResult(elementId, message) {
    const resultElement = document.getElementById(elementId);
    resultElement.innerHTML = `<p>${message}</p>`;
  }



 function connect(){    
            try{
        client.connect({ onSuccess: onConnect,useSSL:mqttUseSSL,userName,password});
        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;
            }catch(error)
            {
          
        
            }
        }
        //............................................................................................
          function onConnect() {
          console.log("onConnect");
      
 
        }
        
        function onConnectionLost(responseObject) {
          if (responseObject.errorCode !== 0) {
            console.log("onConnectionLost:"+responseObject.errorMessage);
        }  setInterval(connect, 1000); }

        function onMessageArrived(message) {
            topic = message.destinationName;
            payload=message.payloadString;
        console.log("Payload:" + payload);
        console.log("Topic:", topic);
         }

    function getDataFromDevice(topic) {
     try{
    console.log("getDataFromDevice "+topic);
    client.subscribe(topic);}
    catch(error){
        console.log(error);}
    }

    connect();

   
      /*  document.getElementById('scheduleJobForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const id = document.getElementById('scheduleJobId').value;
            const cronTime = document.getElementById('scheduleCronTime').value;
            const task = document.getElementById('scheduleTask').value;
            
            fetch('http://localhost:3000/schedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id, cronTime, task })
            })
            .then(response => response.text())
            .then(data => {
                alert(data);
                getJobs();
            })
            .catch(error => console.error('Error scheduling job:', error));
        });*/

        document.getElementById('updateJobForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const id = document.getElementById('updateJobId').value;
            const cronTime = document.getElementById('updateCronTime').value;
            const task = document.getElementById('updateTask').value;
            
            fetch(`http://localhost:3000/jobs/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ cronTime, task })
            })
            .then(response => response.text())
            .then(data => {
                alert(data);
                getJobs();
            })
            .catch(error => console.error('Error updating job:', error));
        });

        document.getElementById('cancelJobForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const id = document.getElementById('cancelJobId').value;
            
            fetch(`http://localhost:3000/cancel/${id}`, {
                method: 'DELETE'
            })
            .then(response => response.text())
            .then(data => {
                alert(data);
                getJobs();
            })
            .catch(error => console.error('Error canceling job:', error));
        });

        document.getElementById('getJobsBtn').addEventListener('click', getJobs);

        function getJobs() {
            fetch('http://localhost:3000/jobs')
                .then(response => response.json())
                .then(data => {
                  document.getElementById('result').textContent = JSON.stringify(data, null, 2);
                })
                .catch(error => {
                    console.error('Error fetching jobs:', error);
                    document.getElementById('result').textContent = 'Error fetching jobs';
                });
        }
    </script>
</body>
</html>
