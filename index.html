
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cron Job Scheduler</title>
    <script src="paho.javascript-1.0.3/paho-mqtt-min.js"></script>
    <script src="connection.js"></script>
</head>
<body>
    <h1>Cron Job Scheduler</h1>
<div>
    <button style="width: 100px;" id="repeat"onclick="display('container1','container2')">Repeat</button>

<button style="width: 100px;" id="onece" onclick="display('container2','container1')">Onece</button>
</div>
  
<div id="container1" style="display: inline;">
    <h2>Schedule - Repeat</h2>
    <form id="scheduleRepeatForm">
      <label for="scheduleRepeatName">Schedule Name:</label>
      <input type="text" id="scheduleRepeatName" name="scheduleRepeatName" required>
      <br><br>
      <label for="scheduleRepeatDays">Select Days:</label><br>
      <input type="checkbox" id="monday" name="scheduleRepeatDays" value="2">
      <label for="monday">Monday</label><br>
      <input type="checkbox" id="tuesday" name="scheduleRepeatDays" value="4">
      <label for="tuesday">Tuesday</label><br>
      <input type="checkbox" id="wednesday" name="scheduleRepeatDays" value="8">
      <label for="wednesday">Wednesday</label><br>
      <input type="checkbox" id="thursday" name="scheduleRepeatDays" value="16">
      <label for="thursday">Thursday</label><br>
      <input type="checkbox" id="friday" name="scheduleRepeatDays" value="32">
      <label for="friday">Friday</label><br>
      <input type="checkbox" id="saturday" name="scheduleRepeatDays" value="64">
      <label for="saturday">Saturday</label><br>
      <input type="checkbox" id="sunday" name="scheduleRepeatDays" value="1">
      <label for="sunday">Sunday</label><br><br>
      <label for="scheduleRepeatTime">Select Time:</label>
      <input type="time" id="scheduleRepeatTime" name="scheduleRepeatTime" required>
      <br><br>
      <button  id="scheduleRepeat" onclick="scheduleCronTime('scheduleRepeat')">Create Schedule</button>
    </form>
</div>


    <div id="container2" style="display: none;">
        <h2>Schedule - onece</h2>
        <form id="scheduleRepeatFormOnece">
          <label for="scheduleOneceName">Schedule Name:</label>
          <input type="text" id="scheduleOneceName" name="scheduleOneceName" required>
          <br><br>
        
          <label for="scheduleOneceTime">Select Time:</label>
          <input type="time" id="scheduleOneceTime" name="scheduleOneceTime" required>
          <br><br>
          <button  id="schedulOnece" onclick="scheduleCronTime('schedulOnece')">Create Schedule</button>
        </form>

    </div> 

    <div id="scheduleRepeatResult"></div>
    <h2>Scheduled Jobs</h2>
    <div id="scheduleJobsList"></div>


<!-- Update Schedule Form -->
<h2>Update Schedule</h2>
<form id="updateScheduleForm">
  <input type="text" id="updateScheduleId" placeholder="Schedule ID" required>
  <input type="text" id="updateScheduleName" placeholder="Schedule Name" required>
  <label><input type="checkbox" name="updateScheduleDays" value="2"> Monday</label>
  <label><input type="checkbox" name="updateScheduleDays" value="4"> Tuesday</label>
  <label><input type="checkbox" name="updateScheduleDays" value="8"> Wednesday</label>
  <label><input type="checkbox" name="updateScheduleDays" value="16"> Thursday</label>
  <label><input type="checkbox" name="updateScheduleDays" value="32"> Friday</label>
  <label><input type="checkbox" name="updateScheduleDays" value="64"> Saturday</label>
  <label><input type="checkbox" name="updateScheduleDays" value="1"> Sunday</label>
  <input type="time" id="updateScheduleTime" required>
  <button type="submit">Update Schedule</button>
</form>

<div id="updateScheduleResult"></div>
<script>



const subTopic="v2jlcwytpqaufx/scene/#",
publish_topic="v2jlcwytpqaufx/scene/timer/";




function connect(){//connect------------------------------------------------------------------
try{
client.connect({ onSuccess: onConnect,useSSL: mqttUseSSL,userName,password });
client.onConnectionLost = onConnectionLost;
client.onMessageArrived = onMessageArrived;

}catch{}}

function onConnect() {
try{
    console.log("onConnect");    
    client.subscribe(subTopic);
    sendCommandToDevice(publish_topic+"list","read");
}
catch{}
}

function sendCommandToDevice(topic,payload) {
  try{
    if (client.isConnected()) {
        console.log("sendCommandToDevice: " + topic + ", Payload: " + payload);
        var message = new Paho.MQTT.Message(payload);
        message.destinationName = topic;
        client.send(message);
    }}
    catch(error)
    {
      console.log(error);
    }
}


function onMessageArrived(message) {
  try{
  topic = message.destinationName;
  payload=message.payloadString;
    console.log("Payload:" + payload);
    console.log("Topic:", topic);
   
    displayJobs(payload);


  }
  catch(error)
  {
    console.log(error);
  } 
}

function onConnectionLost(responseObject) {
  if (responseObject.errorCode !== 0) {
    console.log("onConnectionLost:"+responseObject.errorMessage);

  }
  
}

//const scheduleName=0,days=0,scheduleTime=0,date=0;
function display(id1,id2)
{
    document.getElementById(id1).style.display='inline';
    document.getElementById(id2).style.display='none';
}

function scheduleCronTime(id) {
    event.preventDefault();
    if(id == 'scheduleRepeat'){
     scheduleName = document.getElementById('scheduleRepeatName').value;
     Daystotal = Array.from(document.querySelectorAll('input[name="scheduleRepeatDays"]:checked'))
                 .map(day => parseInt(day.value, 10)) 
                 .reduce((sum, value) => sum + value, 0);  
      date = "*";
      month = "*"; 
      
   scheduleTime = document.getElementById('scheduleRepeatTime').value;
   [hour, minute] = scheduleTime.split(':');
   seconds = 0;
      const scheduleArry = [date,month,minute,hour,seconds,Daystotal,scheduleName];
      sendCommandToDevice(publish_topic+'set', JSON.stringify(scheduleArry));

    }
    if(id == 'schedulOnece'){
     scheduleName = document.getElementById('scheduleOneceName').value;
     Daystotal = "*";
     scheduleTime = document.getElementById('scheduleOneceTime').value;
     [hour, minute] = scheduleTime.split(':');   
        d = new Date();
      date = d.getDate();
      month = d.getMonth() + 1; 
      seconds = 0;
      const scheduleArry = [date,month,minute,hour,seconds,Daystotal,scheduleName];
      sendCommandToDevice(publish_topic+'set', JSON.stringify(scheduleArry));

    }
   
  }

  function displayResult(elementId, message) {
    const resultElement = document.getElementById(elementId);
    resultElement.innerHTML = `<p>${message}</p>`;
  }


  document.getElementById('updateScheduleForm').addEventListener('submit', function(event) {
  event.preventDefault();
  
  const scheduleId = document.getElementById('updateScheduleId').value;
  scheduleName = document.getElementById('updateScheduleName').value;
     Daystotal = Array.from(document.querySelectorAll('input[name="updateScheduleDays"]:checked'))
                 .map(day => parseInt(day.value, 10)) 
                 .reduce((sum, value) => sum + value, 0);  
      date = "*";
      month = "*"; 
      
   scheduleTime = document.getElementById('updateScheduleTime').value;
   [hour, minute] = scheduleTime.split(':');
   seconds = 0;
   const scheduleArry = [date,month,minute,hour,seconds,Daystotal,scheduleName];
   sendCommandToDevice(publish_topic+'update/'+scheduleId, JSON.stringify(scheduleArry));
   console.log('up'+scheduleArry);

});



    function displayJobs(jobs) {
      jobs = JSON.parse(jobs);
    const jobsList = document.getElementById('scheduleJobsList');
    jobsList.innerHTML = ''; // Clear previous jobs
    jobs.forEach(job => {
        const jobElement = document.createElement('div');
        jobElement.innerHTML = `
            <h3>${job.scheduleName}</h3>
            <button onclick="populateUpdateForm(${job.id}, '${job.scheduleName}', '${job.cronTimes.join(', ')}')">Update</button>
              <button onclick="deleteJob(${job.id})">Delete</button>
        `;
        jobsList.appendChild(jobElement);
    });
}
//     <p>Cron Times: ${job.cronTimes.join(', ')}</p>

function populateUpdateForm(id, scheduleName, cronTimes) {
    document.getElementById('updateScheduleId').value = id;
    document.getElementById('updateScheduleName').value = scheduleName;

    const days = cronTimes.split(',').map(time => parseInt(time.trim().split(' ')[4], 10));

  const totalDays = days.reduce((acc, day) => acc + Math.pow(2, day), 0);

  document.querySelectorAll('input[name="updateScheduleDays"]').forEach(checkbox => {
      const value = parseInt(checkbox.value, 10);
      checkbox.checked = (totalDays & value) !== 0;
  });
    const firstCronTime = cronTimes.split(',')[0];
    const [minute, hour] = firstCronTime.split(' ').slice(0, 2);
    const time = `${hour.padStart(2, '0')}:${minute.padStart(2, '0')}`;
    document.getElementById('updateScheduleTime').value = time;

}

    function deleteJob(id) {

      sendCommandToDevice(publish_topic+'delete', JSON.stringify(id));}

connect();
    </script>
</body>
</html>
